<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard Heatmap จุดเก็บขยะ</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
      #controls .control-group button {
        display: block;
        margin: 20px 0;
        padding: 8px 12px;
        font-size: 19px;
        cursor: pointer;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f4f7f6;
        color: #333;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      #container {
        display: flex;
        flex-grow: 1;
        height: 90vh;
        background: #e9e2f1;
        box-shadow: inset 0 0 8px #c6b8e3;
        border-radius: 8px;
        margin: 1rem;
        overflow: hidden;
        gap: 0;
      }

      #controls {
        width: 280px;
        background-color: #7935e6;
        padding: 30px;
        box-sizing: border-box;
        color: #fff5b1;
        display: flex;
        flex-direction: column;
        gap: 18px;
        border-top-left-radius: 8px;
        border-bottom-left-radius: 8px;
        box-shadow: 3px 0 12px rgba(80, 60, 140, 0.5);
        user-select: none;
        flex-shrink: 0;
        margin: 0;
        position: relative;
        overflow-y: auto;
      }

      #controls label {
        font-size: 1.7rem;
        font-weight: 600;
        margin-bottom: 5px;
      }

      #controls input,
      #controls button,
      #controls select {
        width: 100%;
        display: block;
        font-size: 1rem;
        color: #fff5b1;
        box-sizing: border-box;
      }

      #controls input[type="date"],
      #controls select {
        padding: 8px 12px;
        border-radius: 6px;
        border: none;
        font-size: 1rem;
        box-shadow: inset 1px 1px 5px rgba(255 221 87 / 0.25);
        outline-offset: 2px;
        outline-color: #f5cf3a;
        background-color: #e9e2f1;
        color: #4b3678;
        transition: box-shadow 0.3s ease;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234b3678%22%20d%3D%22M287%2C197.3L159.2%2C69.5c-3.2-3.2-8.3-3.2-11.5%2C0L5.4%2C197.3c-3.2%2C3.2-3.2%2C8.3%2C0%2C11.5l11.5%2C11.5c3.2%2C3.2%2C8.3%2C3.2%2C11.5%2C0l125.1-125.1l125.1%2C125.1c3.2%2C3.2%2C8.3%2C3.2%2C11.5%2C0l11.5-11.5C290.2%2C205.6%2C290.2%2C200.5%2C287%2C197.3z%22%2F%3E%3C%2Fsvg%3E"); /* Custom arrow */
        background-repeat: no-repeat;
        background-position: right 10px top 50%;
        background-size: 12px auto;
      }

      #controls input[type="date"]:focus,
      #controls select:focus {
        box-shadow: 0 0 8px 3px #ffdd57;
        outline-color: #ffdd57;
      }

      #controls button {
        background-color: #ffdd57;
        color: #4b3678;
        border: none;
        margin-bottom: 10px;
        padding: 12px 0;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: 700;
        box-shadow: 0 3px 8px rgba(255 221 87 / 0.6);
        user-select: none;
        transition: background-color 0.3s ease, box-shadow 0.3s ease,
          transform 0.2s ease;
      }

      #controls button:last-child {
        margin-bottom: 0;
      }

      #controls button:hover {
        background-color: #f0c90f; /* เหลืองเข้มขึ้น */
        box-shadow: 0 6px 20px rgba(240 201 15 / 0.8);
        transform: translateY(-2px);
      }
      .control-group {
        border-bottom: none;
        padding-bottom: none;
        margin-bottom: none;
      }

      .control-group:last-child {
        border-bottom: none;
        padding-bottom: 0;
        margin-bottom: 0;
      }

      .control-group h3 {
        color: #f5cf3a;
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.3em;
        border-bottom: 3px solid #f5cf3a;
        padding-bottom: 5px;
      }

      #infoPanel {
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 15px;
        box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.2);
        color: #fff5b1;
      }

      #infoPanel p {
        margin: 5px 0;
        font-size: 0.95rem;
      }

      #infoPanel strong {
        color: #ffdd57;
      }

      .playback-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
      }

      .playback-controls button {
        width: auto;
        padding: 8px 15px;
        font-size: 0.9rem;
        margin-bottom: 0;
        flex-shrink: 0;
      }

      .playback-controls input[type="range"] {
        flex-grow: 1;
        -webkit-appearance: none;
        height: 8px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 5px;
        outline: none;
        transition: opacity 0.2s;
      }

      .playback-controls input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #ffdd57;
        cursor: pointer;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      }

      .playback-controls input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #ffdd57;
        cursor: pointer;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      }

      #map {
        flex: 1;
        border-top-right-radius: 8px;
        border-bottom-right-radius: 8px;
        box-shadow: inset 0 0 10px #9c88cc;
        background-color: #f8f6fb;
        margin: 0;
        padding: 0;
        min-width: 0;
      }

      #messageBox {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        justify-content: center;
        align-items: center;
        background-color: rgba(0, 0, 0, 0.3);
      }

      .message-box {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .message-box-content {
        background-color: #ffffff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 400px;
        width: 90%;
        color: #333;
      }

      .message-box-content p {
        margin-bottom: 20px;
        font-size: 1.1em;
        font-weight: 500;
      }

      .message-box-content button {
        background-color: #7935e6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        transition: background-color 0.2s ease;
      }

      .message-box-content button:hover {
        background-color: #5a27b3;
      }

      @media (max-width: 768px) {
        #container {
          flex-direction: column;
          height: auto;
          margin: 0.5rem;
        }

        #controls {
          width: auto;
          border-radius: 8px 8px 0 0;
          box-shadow: 0 3px 12px rgba(80, 60, 140, 0.5);
          padding: 20px;
        }

        #map {
          height: 50vh;
          border-radius: 0 0 8px 8px;
          box-shadow: inset 0 0 10px #9c88cc;
        }
      }
    </style>
  </head>

  <body>
    <div id="container">
      <div id="controls">
        <div class="control-group">
          <h3>ตัวเลือกวันที่</h3>
          <input type="date" id="dateInput" />
          <button onclick="renderGarbageHeatmap()">โหลด Heatmap</button>
          <button onclick="clearHeatmap(true)">เคลียร์ Heatmap</button>
          <button onclick="window.location.href='Generate.html'">
            กลับหน้าหลัก
          </button>
        </div>
      </div>

      <div id="map"></div>
    </div>

    <div id="infoPanel">
      <span>จำนวนจุดเก็บขยะทั้งหมด: <span id="totalPoints">0</span></span>
    </div>

    <div class="message-box" id="messageBox">
      <div class="message-box-content">
        <p id="messageText"></p>
        <button onclick="hideMessageBox()">ปิด</button>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat/dist/leaflet-heat.js"></script>

    <script>
      // Base Maps
      const osmStreet = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        { maxZoom: 20, attribution: "© OpenStreetMap contributors" }
      );
      const osmTopo = L.tileLayer(
        "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
        { maxZoom: 17, attribution: "© OpenTopoMap contributors" }
      );
      const googleSat = L.tileLayer(
        "http://{s}.google.com/vt?lyrs=s&x={x}&y={y}&z={z}",
        { maxZoom: 20, subdomains: ["mt0", "mt1", "mt2", "mt3"] }
      );

      // Map
      const map = L.map("map", {
        center: [16.7476, 100.1937],
        zoom: 15,
        layers: [googleSat],
      });

      // Layer Control
      const baseMaps = {
        "Google Satellite": googleSat,
        "OSM Street": osmStreet,
        "OSM Topo": osmTopo,
      };
      const overlayMaps = {};
      L.control.layers(baseMaps, overlayMaps).addTo(map);

      let heatLayer;
      let markerLayer = L.layerGroup().addTo(map);

      function showMessageBox(msg) {
        document.getElementById("messageText").innerText = msg;
        document.getElementById("messageBox").style.display = "flex";
      }

      function hideMessageBox() {
        document.getElementById("messageBox").style.display = "none";
      }

      function clearHeatmap() {
        if (heatLayer) {
          map.removeLayer(heatLayer);
          heatLayer = null;
          showMessageBox("เคลียร์ Heatmap เรียบร้อยแล้ว");
          document.getElementById("totalPoints").innerText = 0;
        }
      }

      function renderGarbageHeatmap() {
        const date = document.getElementById("dateInput").value;
        if (!date) {
          showMessageBox("กรุณาเลือกวันที่");
          return;
        }

        const url = `http://localhost/GPS_Tracking/get_gps_data.php?date=${date}`;
        fetch(url)
          .then((res) => res.json())
          .then((data) => {
            const garbageData = data.garbage_point;
            if (
              !garbageData ||
              !garbageData.features ||
              garbageData.features.length === 0
            ) {
              showMessageBox("ไม่พบข้อมูลจุดเก็บขยะ");
              return;
            }

            clearHeatmap();

            const validFeatures = garbageData.features.filter(
              (f) => f.geometry && f.geometry.coordinates
            );
            if (validFeatures.length === 0) {
              showMessageBox("ไม่พบจุดเก็บขยะที่มีพิกัด");
              return;
            }

            const heatData = validFeatures.map((f) => [
              f.geometry.coordinates[1],
              f.geometry.coordinates[0],
              1,
            ]);
            heatLayer = L.heatLayer(heatData, {
              radius: 25,
              blur: 15,
              maxZoom: 17,
            }).addTo(map);
            document.getElementById("totalPoints").innerText =
              validFeatures.length;

            map.fitBounds(heatData.map((d) => [d[0], d[1]]));

            validFeatures.forEach((f) => {
              const latlng = [
                f.geometry.coordinates[1],
                f.geometry.coordinates[0],
              ];
              L.circleMarker(latlng, {
                radius: 5,
                color: "green",
                fillOpacity: 0.7,
              })
                .addTo(map)
                .bindPopup(
                  `ชื่อจุด: ${f.properties.name}<br>เวลา: ${f.properties.detected_time}`
                );
            });
          })
          .catch((err) => {
            console.error(err);
            showMessageBox("โหลดข้อมูลผิดพลาด");
          });
      }

      //--- legend ---
      function addHeatmapLegend() {
        const legend = L.control({ position: "bottomright" });

        legend.onAdd = function (map) {
          const div = L.DomUtil.create("div", "info legend");
          const grades = [0, 1, 2, 3, 4]; // ค่า intensity ของ heatmap (ปรับตามต้องการ)
          const colors = ["#00f", "#0f0", "#ff0", "#f90", "#f00"]; // ฟ้า → เขียว → เหลือง → แดง

          div.innerHTML = "<h4>ความหนาแน่น</h4>";
          for (let i = 0; i < grades.length; i++) {
            div.innerHTML +=
              `<i style="background:${colors[i]}; width:18px; height:18px; display:inline-block; margin-right:5px;"></i> ` +
              `${grades[i]}${
                grades[i + 1] ? "&ndash;" + grades[i + 1] + "<br>" : "+"
              }`;
          }
          return div;
        };

        legend.addTo(map);
      }

      // --- เรียกใช้ Legend หลัง map พร้อม heatmap ---
      renderGarbageHeatmap();
      addHeatmapLegend(); // Add Legend //
    </script>
  </body>
</html>
